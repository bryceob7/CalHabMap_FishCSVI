---
title: "HABs_Cleanup"
author: "Curtis Cha"
date: "3/23/2022"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(pacman)
pacman::p_load(tidyverse, tigris, lubridate, sf, mapview, finch)
```

```{r setup}
# use finch package to read in the Darwin core archive file format
hab_dwca <- dwca_read("https://www1.usgs.gov/obis-usa/ipt/archive.do?r=calhabmap&v=1.3")

hab_events <- read.delim(hab_dwca$data[1])
hab_occ <- read.delim(hab_dwca$data[2])
water_qual <- read.delim(hab_dwca$data[3])
```

```{r setup}
#clean up hab_events, (EPSG:4326 WGS84), this df provides location data

hab_events <- hab_events %>% mutate(locationID = str_extract(hab_events$id,"[^HABs-](\\w+)(?=_)")) %>% group_by(locationID) %>% summarise(latitude = unique(decimalLatitude), longitude = unique(decimalLongitude), datum = unique(geodeticDatum))

#clean up hab_occ

hab_occ <- hab_occ %>% mutate(species = paste(scientificName, "(", organismQuantityType, ")")) %>% select(id, organismQuantity, species) %>% pivot_wider(names_from = species, values_from=organismQuantity) %>% mutate_all(~replace(., is.na(.), 0))
  
#clean up water_qual, only look at temp
water_qual <- water_qual %>%  mutate(measurement = paste(measurementType, "(", measurementUnit, ")")) %>% select(id, measurementValue, measurement) %>% pivot_wider(names_from = measurement, values_from=measurementValue) %>% select(id, "Temp ( Celsius )" )

#combined hab_occ and water_quality to biological, chemical, and physical data for each given location/time. Location and time data were extracted from the eventID string, and long/lat taken from hab_events df, then converted to sf

hab_occ_wq <- merge(hab_occ, water_qual, by = c('id')) %>% mutate(locationID = str_extract(id, "[^HABs-](\\w+)(?=_)"), eventDate = ymd(str_extract(id, "(\\d+-\\d+-\\d+)"))) %>% merge(hab_events, by = c('locationID')) %>%  select("id", "locationID", "eventDate", "Temp ( Celsius )" , "Akashiwo sanguinea ( cells/L )", "Alexandrium ( cells/L )", "Cochlodinium ( cells/L )", "Dinophysis ( cells/L )", "Lingulodinium polyedra ( cells/L )", "Pseudo-nitzschia delicatissima ( cells/L )", "Pseudo-nitzschia seriata ( cells/L )", "longitude", "latitude") %>% rename_with(~gsub("\\s", "", .x)) %>% st_as_sf(coords = c('longitude', 'latitude'), crs = 4326) %>% drop_na() %>% filter(eventDate >= "2008-01-01")

```

```{r }
#CSVI data directly downloaded from NOAA NMFS Social Indicator Tool
CSVI <- read_csv("./Data/socialIndicatorData.csv") %>% filter(State == "CA", Year == 2018) %>% rename("NAME" = "Community Name") %>% select(-c("Supporting Information", "Data Series", "Year", "State", "Region"))

# use tigris package to extrac shpfiles for CA "06" for year 2018
CA_places <- places(state="06", cb = T, year = "2018") %>% filter(NAME %in% CSVI$NAME) %>% select(NAME, geometry)

CA_county <- counties(state="06", year = "2018") %>% select(COUNTYFP, NAME, geometry) 

#use tigris to merge CSVI df to CA_place shp
CSVI_shp <- geo_join(CA_places, CSVI, "NAME", "NAME")

#using sf to represent CA counties by max CSVI scores of places
#attach county information to places, and groupby county and summarize
#changed lines 57 to 62, converted st_join output to data by dropping geometry, final output a df of county and maximum CSVI scores. Renamed from CSVI_shp2 to CSVI_county and removed places name
CSVI_county <- st_join(CSVI_shp, CA_county) %>%  
  group_by(COUNTYFP) %>% 
  summarise_at(vars(-geometry), max) %>% 
  st_set_geometry(value = NULL) %>% 
  select(-NAME.x)

# removed this line at 63 CSVI_shp2$geometry <- st_union(CSVI_shp2$geometry)
#renamed CA_county2 to county_data, replace st_join with geo_join

county_data <- geo_join(CA_county %>% filter(COUNTYFP %in% CSVI_county$COUNTYFP), 
                       CSVI_county, "COUNTYFP", "COUNTYFP")

#replaced map of places and commercial engagement index with map of counties and commercial engagement index, added layer of countines visualized by Commercial Fishing engagement
mapview(county_data, zcol = "Commercial Engagement Categorical Ranking") + mapview(county_data, zcol = "Commercial Reliance Categorical Ranking")
```

```{r prelim data analysis}
#only certain species are of interest: Akashi sanguinea (reported fish and bird kills), Alexandriua (causes paralytic shellfish poisoning), cochlodinium (fish kills), dinophysis and lingulodinium (diarrhetic shellfish poisoining), and pseudo-nitzhcia (amnesic shellfishing poisoning)
#source: https://calhabmap.org/prorocentrum-spp

#should do some linear models to observe SST and certain location -> certain HABs are dependent on a location, certain areas have higher SST's

#timeseries analysis to observe whether certain species are increasing over time, depending on GLM outputs, may have to subset by location rather than statewide
SST <- ggplot(hab_occ_wq, aes(x = eventDate, y = `Temp(Celsius)`, color = locationID, group = locationID)) + geom_line()



```